name: macOS Tests

on:
  workflow_call:
    inputs:
      ref:
        required: false
        type: string

jobs:
  macos:
    name: macOS Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15-intel]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Setup ClickHouse
        run: |
          curl https://clickhouse.com/ | sh

          # Diagnostic: try --daemon and capture what happens (for bug report)
          echo "=== Diagnostic: testing --daemon flag ==="
          echo "ClickHouse version:"
          ./clickhouse --version || true

          echo -e "\nAttempting: ./clickhouse server --daemon"
          ./clickhouse server --daemon > daemon_stdout.log 2>&1
          DAEMON_EXIT_CODE=$?
          echo "Exit code: $DAEMON_EXIT_CODE"

          echo -e "\nStdout/stderr from --daemon:"
          cat daemon_stdout.log || echo "(empty)"

          echo -e "\nChecking for clickhouse processes:"
          pgrep -l clickhouse || echo "No clickhouse processes found"

          echo -e "\nChecking for log files in common locations:"
          ls -la ./clickhouse-server.log 2>/dev/null || echo "No ./clickhouse-server.log"
          ls -la /var/log/clickhouse-server/ 2>/dev/null || echo "No /var/log/clickhouse-server/"
          ls -la ~/clickhouse-server.log 2>/dev/null || echo "No ~/clickhouse-server.log"

          echo -e "\nChecking for pid files:"
          ls -la ./clickhouse-server.pid 2>/dev/null || echo "No ./clickhouse-server.pid"
          ls -la /var/run/clickhouse-server/ 2>/dev/null || echo "No /var/run/clickhouse-server/"

          # Test if daemon actually responds to requests
          echo -e "\nWaiting for daemon to respond (up to 30s):"
          DAEMON_READY=false
          for i in {1..30}; do
            if curl -s http://localhost:8123/ping > /dev/null 2>&1; then
              echo "Daemon responded after $i seconds"
              DAEMON_READY=true
              break
            fi
            # Check if process is still alive
            if ! pgrep clickhouse > /dev/null 2>&1; then
              echo "Daemon process died after $i seconds"
              break
            fi
            echo "  Waiting... ($i/30)"
            sleep 1
          done

          if [ "$DAEMON_READY" = true ]; then
            echo -e "\nDaemon is responding! Running test queries:"
            echo "  /ping:"
            curl -s http://localhost:8123/ping
            echo -e "\n  SELECT 1:"
            curl -s "http://localhost:8123/?query=SELECT%201"
            echo -e "\n  SELECT version():"
            curl -s "http://localhost:8123/?query=SELECT%20version()"
            echo -e "\nDaemon test PASSED - --daemon flag works on this system"
          else
            echo -e "\nDaemon test FAILED - server did not respond within 30 seconds"

            # Check for macOS crash reports
            echo -e "\nChecking for macOS crash reports:"
            ls -la ~/Library/Logs/DiagnosticReports/ 2>/dev/null | grep -i clickhouse || echo "No clickhouse crash reports in DiagnosticReports"
            ls -la /Library/Logs/DiagnosticReports/ 2>/dev/null | grep -i clickhouse || echo "No clickhouse crash reports in system DiagnosticReports"

            # Show recent crash reports if any
            CRASH_REPORT=$(ls -t ~/Library/Logs/DiagnosticReports/*clickhouse* 2>/dev/null | head -1)
            if [ -n "$CRASH_REPORT" ]; then
              echo -e "\nMost recent crash report ($CRASH_REPORT):"
              head -100 "$CRASH_REPORT"
            fi

            # Check system log for clues
            echo -e "\nRecent system log entries for clickhouse:"
            log show --predicate 'process == "clickhouse"' --last 1m 2>/dev/null | tail -20 || echo "No entries found in system log"
          fi

          # Kill any leftover processes before real startup
          echo -e "\nCleaning up daemon process..."
          pkill -9 clickhouse 2>/dev/null || true
          sleep 1

          echo -e "\n=== End diagnostic. Starting server with background process ==="

          # Start server in background (--daemon may not work reliably on macOS)
          ./clickhouse server > clickhouse.log 2>&1 &
          SERVER_PID=$!
          echo "Started ClickHouse server with PID $SERVER_PID"

          # Wait for ClickHouse to be ready
          for i in {1..30}; do
            if curl -s http://localhost:8123/ping > /dev/null 2>&1; then
              echo "ClickHouse is ready"
              break
            fi
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "ClickHouse process died. Log output:"
              cat clickhouse.log
              exit 1
            fi
            echo "Waiting for ClickHouse to start... ($i/30)"
            sleep 1
          done

          # Verify server is responding
          if ! curl -s http://localhost:8123/ping; then
            echo "ClickHouse failed to start. Log output:"
            cat clickhouse.log
            exit 1
          fi

      - uses: actions/cache@v5
        name: Cache NuGet
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            10.x

      - name: Test
        run: dotnet test ClickHouse.Driver.Tests/ClickHouse.Driver.Tests.csproj
              --framework net10.0 --configuration Release --verbosity normal --logger GitHubActions
              /clp:ErrorsOnly /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:SkipAutoProps=true
        env:
          CLICKHOUSE_CONNECTION: Host=localhost;Port=8123;Username=default
          CLICKHOUSE_TEST_ENVIRONMENT: local_quick_setup
